---
import MainLayout from "../layouts/MainLayout.astro";
import { Image } from "astro:assets";
import logo from "../assets/images/floor-boss-icon.jpg";

const WHATSAPP_NUMBER = '+2349165208580'; // IMPORTANT: Replace with your actual WhatsApp number

const pageTitle = "FLOOR BOSS ng - Your Shopping Cart";
const pageDescription = "Review your selected flooring products and confirm your order with FLOOR BOSS ng in Abuja. Easy WhatsApp ordering for all your flooring needs.";
const pageCanonicalURL = Astro.url.origin + Astro.url.pathname;
---

<MainLayout 
  title={pageTitle}
  description={pageDescription}
  canonicalURL={pageCanonicalURL}
>
  <div class="container mx-auto px-6 py-12">
    <section class="py-12">
      <div class="flex flex-col items-center gap-4">
        <Image
          src={logo}
          alt="FLOOR BOSS ng"
          class="w-16 h-16 rounded-2xl object-cover border border-stone-200 shadow-sm"
          width={128}
          height={128}
          loading="eager"
          decoding="async"
        />
        <h1 class=" text-3xl md:text-5xl font-black text-center text-stone-900">Your Shopping Cart</h1>
        <p class="text-sm text-stone-500">
          Receipt-ready summary for your order.
        </p>
      </div>
      <div id="cart-container" class="mt-12 max-w-4xl mx-auto">
        <!-- Cart items will be rendered here by JavaScript -->
      </div>
    </section>
  </div>
</MainLayout>

<script define:vars={{ WHATSAPP_NUMBER }}>
  document.addEventListener('DOMContentLoaded', () => {
    const cartContainer = document.getElementById('cart-container');
    let cart = JSON.parse(localStorage.getItem('cart')) || [];

    function formatPrice(price) {
      return new Intl.NumberFormat('en-NG', {
        style: 'currency',
        currency: 'NGN',
        minimumFractionDigits: 0,
      }).format(price);
    }

    function updateCart(id, newQuantity) {
      const product = cart.find(item => item.id === id);
      if (product) {
        if (newQuantity <= 0) {
          cart = cart.filter(item => item.id !== id);
        } else {
          product.quantity = newQuantity;
        }
      }
      localStorage.setItem('cart', JSON.stringify(cart));
      renderCart();
    }

    function removeItem(id) {
      cart = cart.filter(item => item.id !== id);
      localStorage.setItem('cart', JSON.stringify(cart));
      renderCart();
    }

    function renderCart() {
      if (cart.length === 0) {
        cartContainer.innerHTML = '<p class="text-center text-stone-500">Your cart is empty. <a href="/" class="text-stone-700 font-bold hover:underline">Continue Shopping</a></p>';
        return;
      }

      let total = 0;
      let cartHTML = '<div class="space-y-6">';

      cart.forEach(item => {
        const subtotal = item.price * item.quantity;
        total += subtotal;
        cartHTML += `
          <div class="flex flex-col sm:flex-row items-center justify-between bg-white p-4 rounded-lg shadow-sm border border-stone-100 gap-4">
            <div class="flex items-center space-x-4 w-full sm:w-auto">
              <img src="${item.image}" alt="${item.name}" class="w-16 h-16 object-cover rounded-md border" />
              <div class="flex-1">
                <h3 class="text-base font-bold text-stone-800 leading-tight">${item.name}</h3>
                <p class="text-sm text-stone-500">${formatPrice(item.price)}</p>
              </div>
            </div>

            <div class="flex items-center justify-between w-full sm:w-auto sm:space-x-8 border-t sm:border-0 pt-3 sm:pt-0">
              <div class="flex items-center gap-3">
                <label class="text-xs uppercase tracking-[0.2em] text-stone-500">
                  Qty
                </label>
                <input
                  type="number"
                  min="1"
                  step="1"
                  value="${item.quantity}"
                  data-id="${item.id}"
                  class="quantity-input w-20 text-center font-bold text-stone-800 border border-stone-200 rounded-lg py-2 focus:outline-none focus:ring-2 focus:ring-[var(--brand-orange)]"
                />
              </div>
              
              <div class="flex items-center space-x-6">
                <p class="text-lg font-black text-stone-900 w-24 text-right">${formatPrice(subtotal)}</p>
                <button data-id="${item.id}" class="remove-item-btn text-red-400 hover:text-red-600 transition-colors p-2" aria-label="Remove item">
                  <svg class="w-4 h-4" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" aria-hidden="true">
                    <path d="M3 6h18"></path>
                    <path d="M8 6V4h8v2"></path>
                    <path d="M6 6l1 14h10l1-14"></path>
                    <path d="M10 11v6"></path>
                    <path d="M14 11v6"></path>
                  </svg>
                </button>
              </div>
            </div>
          </div>
        `;
      });

      cartHTML += `</div>`; // Close space-y-6
      
      cartHTML += `
        <div class="mt-8 pt-6 border-t flex justify-end items-center">
          <div class="text-right">
            <p class="text-2xl font-black text-stone-900">Total: ${formatPrice(total)}</p>
            <button id="whatsapp-order-btn" class="mt-4 w-full md:w-auto bg-[var(--brand-orange)] text-white py-3 px-8 rounded-lg font-semibold text-lg transition-colors duration-300 hover:bg-[var(--brand-orange-dark)]">
              Confirm Order on WhatsApp
            </button>
          </div>
        </div>
      `;

      cartContainer.innerHTML = cartHTML;

      // Quantity input listeners
      document.querySelectorAll('.quantity-input').forEach(input => {
        input.addEventListener('change', (event) => {
          const target = event.currentTarget;
          const id = parseInt(target.dataset.id);
          let nextQuantity = parseInt(target.value);
          if (Number.isNaN(nextQuantity) || nextQuantity < 1) {
            nextQuantity = 1;
            target.value = '1';
          }
          updateCart(id, nextQuantity);
        });
      });

      // Remove Item Listeners
      document.querySelectorAll('.remove-item-btn').forEach(button => {
        button.addEventListener('click', (event) => {
          const btn = event.currentTarget; // <--- FIX: always gets the button
          const id = parseInt(btn.dataset.id);
          removeItem(id);
        });
      });

      document.getElementById('whatsapp-order-btn').addEventListener('click', () => {
        let message = `Hello Floor Boss, I want to order from Abuja:

`;
        let total = 0;

        cart.forEach(item => {
          message += `${item.quantity}x ${item.name}
`;
          total += item.price * item.quantity;
        });

        message += `
Total: ${formatPrice(total)}`;

        const whatsappUrl = `https://wa.me/${WHATSAPP_NUMBER}?text=${encodeURIComponent(message)}`;
        window.open(whatsappUrl, '_blank');
      });
    }

    renderCart();
  });
</script>
